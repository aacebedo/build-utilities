sudo: required
  
language: python

python:
 - 3.5

services:
  - docker

before_install:
  - sudo apt-get update
  - sudo apt-get install -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y --force-yes -q docker-engine
  - docker build -t build-image:alpine_$TRAVIS_BRANCH_amd64 --build-arg BRANCH=$TRAVIS_BRANCH -f environments/build/Dockerfile.alpine environments/build
  - docker build -t build-image:xenial_$TRAVIS_BRANCH_amd64 --build-arg BRANCH=$TRAVIS_BRANCH -f environments/build/Dockerfile.xenial environments/build
  - sudo mkdir -m 777 -p /build/alpine/amd64/install /build/alpine/amd64/packages /build/alpine/amd64/install/lib/python3.5/site-packages/
  - sudo mkdir -m 777 -p /build/xenial/amd64/install /build/xenial/amd64/packages /build/xenial/amd64/install/lib/python3.5/site-packages/
  
script: 
  - docker run -t --rm -v /build:/build build-image:alpine_$TRAVIS_BRANCH_amd64 zsh -c "cd /src && ./setup.py install --prefix=/build/alpine/amd64/install"
  - docker run -t --rm -v /build:/build build-image:alpine_$TRAVIS_BRANCH_amd64 zsh -c "cd /build/alpine/amd64/install/ && fpm -t tar -n build-utilities -p /build/alpine/amd64/packages -a amd64 -f --prefix /usr/local --url https://github.com/aacebedo/build-utilities -v $TRAVIS_BRANCH -s dir ."
  - docker build -t aacebedo/build-utilities:alpine_$TRAVIS_BRANCH_amd64 --build-arg BRANCH=$TRAVIS_BRANCH -f environments/run/Dockerfile.alpine environments/run
  
  - docker run -t --rm -v /build:/build build-image:xenial_$TRAVIS_BRANCH_amd64 zsh -c "cd /src && ./setup.py install --prefix=/build/xenial/amd64/install"
  - docker run -t --rm -v /build:/build build-image:xenial_$TRAVIS_BRANCH_amd64 zsh -c "cd /build/xenial/amd64/install/ && fpm -t tar -n build-utilities -p /build/xenial/amd64/packages -a amd64 -f --prefix /usr/local --url https://github.com/aacebedo/build-utilities -v $TRAVIS_BRANCH -s dir ."
  - docker build -t aacebedo/build-utilities:xenial_$TRAVIS_BRANCH_amd64 --build-arg BRANCH=$TRAVIS_BRANCH -f environments/run/Dockerfile.xenial environments/run
  

after_success:
  - sudo chmod -R a+rwX /build
  - mv /build/alpine/amd64/packages/build-utilities.tar /build/alpine/amd64/packages/build-utilities_alpine_$TRAVIS_BRANCH_amd64.tar
  - mv /build/xenial/amd64/packages/build-utilities.tar /build/xenial/amd64/packages/build-utilities_xenial_$TRAVIS_BRANCH_amd64.tar
  
deploy:
  - provider: releases
    skip_cleanup: true
    api-key: $GITHUB_TOKEN
    file:
      - /build/alpine/amd64/packages/build-utilities_alpine_$TRAVIS_BRANCH_amd64.tar
      - /build/xenial/amd64/packages/build-utilities_xenial_$TRAVIS_BRANCH_amd64.tar
    on:
      tags: true
  - provider: script
    script:
      - docker login -u $BINTRAY_USERNAME -p $BINTRAY_APIKEY -e $BINTRAY_EMAIL aacebedo-docker-build-utilities-docker.bintray.io && docker tag aacebedo/build-utilities:alpine_$TRAVIS_BRANCH_amd64 aacebedo-docker-build-utilities-docker.bintray.io/build-utilities:alpine_$TRAVIS_BRANCH_amd64 && docker push aacebedo-docker-build-utilities-docker.bintray.io/build-utilities:alpine_$TRAVIS_BRANCH_amd64
      - docker login -u $BINTRAY_USERNAME -p $BINTRAY_APIKEY -e $BINTRAY_EMAIL aacebedo-docker-build-utilities-docker.bintray.io && docker tag aacebedo/build-utilities:xenial_$TRAVIS_BRANCH_amd64 aacebedo-docker-build-utilities-docker.bintray.io/build-utilities:xenial_$TRAVIS_BRANCH_amd64 && docker push aacebedo-docker-build-utilities-docker.bintray.io/build-utilities:xenial_$TRAVIS_BRANCH_amd64
    on:
      tags: true
      